
== How I revised the original

This project of mine is based entirely on the Gradle project's documentation:

- link:https://docs.gradle.org/current/userguide/testing_gradle_plugins.html[`Testing Gradle plugins`]

I will call this article as "the original". My sample code set has some differences from the original. Let me enumerate the differences and add some explanations.

=== How to construct Composite projects

The original proposes a way how the consumer project is associated with the plugin development project, as follows:

image:file.png[] `include-plugin-build/build.gradle`
----
plugins {
    id 'org.myorg.url-verifier'
}
----

image:file.png[] `include-plugin-build/settings.gradle`
----
pluginManagement {
    includeBuild '../url-verifier-plugin'
}
----

This didn't work for me. link:https://github.com/kazurayam/TestingGradlePlugins-revised/issues/1[When I ran it], I got the following error:

----
$ basename $(pwd)
include-plugin-build
$ gradle verifyUrl

FAILURE: Build failed with an exception.

* Where:
Build file '/Users/kazuakiurayama/tmp/url-verifier-gradle-plugin/include-plugin-build/build.gradle' line: 2

* What went wrong:
Plugin [id: 'org.myorg.url-verifier'] was not found in any of the following sources:

- Gradle Core Plugins (plugin is not in 'org.gradle' namespace)
- Included Builds (None of the included builds contain this plugin)
- Plugin Repositories (plugin dependency must include a version number for this source)
...
----

So I revised this part as follows:

image:file.png[] `include-plugin-build/build.gradle`
----
include::../../include-plugin-build/build.gradle[]
----

image:file.png[] `include-plugin-build/settings.gradle`
----
include::../../include-plugin-build/settings.gradle[]
----

I learned this from an article
link:https://ncorti.com/blog/gradle-plugins-and-composite-builds[Gradle plugins and Composite builds] by ncorti.


=== Why not doing publishToMavenLocal?

I could publish the custom Gradle plugin `org.myorg.url-verifier` to the mavenLocalRepository. How to?

image:file.png[] `url-verifier-plugin/build.gradle`
[source,groovy]
----
include::../../url-verifier-plugin/build.gradle[lines=1..12]
----

and I execute the following command:

----
$ basename $(pwd)
url-verifier-plugin
$ ./gradlew publishToMavenLocal
----

then I got the plugin's jar file saved:

----
$ pwd
/Users/kazuakiurayama/.m2/repository/org/myorg/url-verifier-plugin/1.2
$ ls -la
total 32
drwxr-xr-x  5 kazuakiurayama  staff   160  6 22 11:03 .
drwxr-xr-x  7 kazuakiurayama  staff   224  6 22 11:03 ..
-rw-r--r--  1 kazuakiurayama  staff  5840  6 22 11:03 url-verifier-plugin-1.2.jar
-rw-r--r--  1 kazuakiurayama  staff  1916  6 22 11:03 url-verifier-plugin-1.2.module
-rw-r--r--  1 kazuakiurayama  staff   757  6 22 11:03 url-verifier-plugin-1.2.pom
----

Once the plugin's jar is published in the mavenLocal repository, the following configuration also worked.

image:file.png[] `include-plugin-build/build.gradle`
----
buildscript {
    repositories {
        mavenLocal()
    }
    dependencies {
        classpath 'org.myorg:url-verifier-plugin:1.2'
    }
}
apply plugin: 'org.myorg.url-verifier'

verification {
    url = 'https://www.google.com/'
}
----

image:file.png[] `include-plugin-build/settings.gradle`
----
/* I do not use includeBuild */
----

This way worked. But I wasn't fully contented with it. Why? I found 2 issues here.

1. I have to repeat running `publishToMavenLocal` task
2. The plugin's version number `1.2` is repeated in 2 build.gradle file

I would definitely repeat changing the plugin and testing it. I do not like to repeat running `publishToMavenLocal` task, I do not like to repeat coding the version number at multiple places.

=== integrationTest depends on classes in the main source set

I added the following line:

image:file.png[] `url-verifier-plugin/build.gradle`
----
include::../../url-verifier-plugin/build.gradle[lines=50..53]
----

This single line makes the classes in the `main source set available for the test class in the `integrationTest` source set. Without this, the integrationTest does not compile:

----
$ basename $(pwd)
url-verifier-plugin
$ ./gradlew integrationTest

> Task :compileIntegrationTestGroovy
startup failed:
/Users/kazuakiurayama/github/TestingGradlePlugins-revised/url-verifier-plugin/src/integrationTest/groovy/org/myorg/http/DefaultHttpCallerIntegrationTest.groovy: 11: unable to resolve class HttpCaller
 @ line 11, column 5.
       @Subject HttpCaller httpCaller = new DefaultHttpCaller()
       ^

/Users/kazuakiurayama/github/TestingGradlePlugins-revised/url-verifier-plugin/src/integrationTest/groovy/org/myorg/http/DefaultHttpCallerIntegrationTest.groovy: 11: unable to resolve class DefaultHttpCaller
 @ line 11, column 38.
       @Subject HttpCaller httpCaller = new DefaultHttpCaller()
                                        ^

2 errors


> Task :compileIntegrationTestGroovy FAILED

FAILURE: Build failed with an exception.

* What went wrong:
Execution failed for task ':compileIntegrationTestGroovy'.
> Compilation failed; see the compiler error output for details.
----

The original wrote this as:
----
    integrationTestImplementation(project)
----

But I prefer writing `sourceSets.main.output` here instead of `project` to be more explicit.

=== Added java codes as example

The original misses some of the sources of Java classes.

.Classes that make the Custom Plugin
|===
|class name|in the original

|link:https://github.com/kazurayam/TestingGradlePlugins-revised/blob/master/url-verifier-plugin/src/main/java/org/myorg/http/DefaultHttpCaller.java[org.myorg.http.DefaultHttpCaller]
|presented

|link:https://github.com/kazurayam/TestingGradlePlugins-revised/blob/master/url-verifier-plugin/src/main/java/org/myorg/http/HttpCallException.java[org.myorg.http.HttpCallException]
|missing

|link:https://github.com/kazurayam/TestingGradlePlugins-revised/blob/master/url-verifier-plugin/src/main/java/org/myorg/http/HttpCaller.java[org.myorg.http.HttpCaller]
|missing

|link:https://github.com/kazurayam/TestingGradlePlugins-revised/blob/master/url-verifier-plugin/src/main/java/org/myorg/http/HttpResponse.java[org.myorg.http.HttpResponse]
|presented

|link:https://github.com/kazurayam/TestingGradlePlugins-revised/blob/master/url-verifier-plugin/src/main/java/org/myorg/tasks/UrlVerify.java[org.myorg.tasks.UrlVerify]
|presented

|link:https://github.com/kazurayam/TestingGradlePlugins-revised/blob/master/url-verifier-plugin/src/main/java/org/myorg/UrlVerifierExtension.java[org.myorg.UrlVerifierException]
|missing

|link:https://github.com/kazurayam/TestingGradlePlugins-revised/blob/master/url-verifier-plugin/src/main/java/org/myorg/UrlVerifierPlugin.java[org.myorg.UrlVerifierPlugin]
|presented

|===

So I guessed how the missing codes should be. I added them in the sample project.