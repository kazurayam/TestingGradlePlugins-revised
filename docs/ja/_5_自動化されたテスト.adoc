
== 自動化テストを作る

=== テストのソースのディレクトリ構造

カスタムGradleプラグインを開発するプロジェクトの名前は `url-verifier-plugin` です。このプロジェクトにはソースコードを格納するためのディレクトリが４つあります。すなわち

1. `src/main/`
2. `src/test/`
3. `src/integrationTest/`
4. `src/functionalTest/`

これらサブディレクトリがGradleのlink:https://www.baeldung.com/gradle-source-sets[Source Set]に対応します。

image:console.png[]
----
$ basename $(pwd)
url-verifier-plugin
$ tree . -L 3
.
└── src
    ├── functionalTest
    │   └── groovy
    ├── integrationTest
    │   └── groovy
    ├── main
    │   ├── java
    │   └── resources
    └── test
        └── groovy
----

`src/main/` ディレクトリにはカスタムGradleプラグイン本体のJavaソースコードが格納されています。

残り３つのディレクトリには自動化テストのコードが格納されています。

`src/test/` ディレクトリには`src/main`のコードをユニット・テストするためのコードが格納されています。

`src/integrationTest/` ディレクトリにはインテグレーション・テストのためのコードが格納されています。インテグレーション・テストとはそれを実行するのに他のリソース（`http://`で始まるURLやデータベース）と接続する必要があるテストです。

`src/functionalTest/` ディレクトリにはファンクショナル・テストのためのコードが格納されています。ファンクショナル・テストとはテスト対象であるカスタムGradleプラグインを利用者の視点からテストするものです。ファンクショナル・テストはカスタムGradleプラグインを呼び出すような`build.gradle`ファイルを動的に生成し即座に実行します。そしてプラグインからの出力を調べてプラグインの動作を検証します。

=== カスタムなSource SetとカスタムなTaskを作る

Gradleは _Source sets_ という概念をもっています。Source Setによってプログラムのソースコード群を分類することができます。_Source Sets_ についてわたしは link:https://www.baeldung.com/gradle-source-sets["Gradle Source Sets", Baeldung] を参考にしました。

ちなみに `url-verifier-plugin` プロジェクトは `groovy` プラグインと `java-gradle-plugin` プラグインを使っています。

image:file.png[] `url-verifier-plugin/build.gradle`
[source,groovy]
----
include::../../url-verifier-plugin/build.gradle[lines=1..3]
----

`groovy` プラグインを適用することにより、`url-verifier-plugin` プロジェクトのなかに２つの source sets が自動的につくられます。すなわち `main` と `test` です。

`main` ソースセットは `url-verifier-plugin/src/main/` ディレクトリに格納されたソースコードに対応します。そこにはカスタムプラグインのソースがあります。

`test` ソースセットは `url-verifier-plugin/src/test/` ディレクトリに格納されたソースコードに対応します。そこにはユニットテストのソースがあります。

あと２つ、ソースセットを明示的に追加しました。すなわち `integrationTest` と `functionalTest` です。どうやって追加したか、次のコードを参照してください。

image:file.png[] `url-verifyer-plugin/build.gradle`
[source,groovy]
----
include::../../url-verifier-plugin/build.gradle[lines=14..33]
----

ついでにカスタムタスク `:check` を定義しました。`:check`タスクは `:integrationTest` タスクと `:functionalTest` タスクを呼び出します。

=== java-gradle-pluginプラグインを設定する

ファンクショナル・テスト
link:https://github.com/kazurayam/TestingGradlePlugins-revised/blob/master/url-verifier-plugin/src/functionalTest/groovy/org/myorg/UrlVerifierPluginFunctionalTest.groovy[`UrlVerifierPluginFunctionalTest`]
がカスタムGradleプラグインを実行するときに
link:https://docs.gradle.org/current/javadoc/org/gradle/testkit/runner/GradleRunner.html[`org.gradle.testkit.runner.GradleRunner`] クラスの助けを必要とします。GradleRunnerクラスは
link:https://docs.gradle.org/current/userguide/java_gradle_plugin.html[`java-gradle-plugin`]
プラグインによって提供されます。ファンクショナル・テストのコードに対して`GradleRunner`クラスをimport可能にするために、1行だけ設定を書く必要があります。

image:file.png[] `url-verifier-plugin/build.gradle`
[source,groovy]
----
include::../../url-verifier-plugin/build.gradle[lines=56..62]
----


=== テスト・フレームワーク Spock　を使えるようにする

テスト・フレームワーク link:https://spockframework.org/[Spock] を使って自動化テストを書くことにしました。もちろんSpockを使わずJUnitやTestNGを使って書くこともできます。お好みで。

`url-verifier-plugin/build.gradle` ファイルと `url-verifier-plugin/settings.gradle` にSpockに関する設定を記述しました。

image:file.png[] `url-verifier-plugin/build.gradle`
[source,groovy]
----
include::../../url-verifier-plugin/build.gradle[lines=35..42]
----

NOTE: `platform(...)` とは何でしょうか？ link:https://docs.gradle.org/current/userguide/platforms.html#sub:using-platform-to-control-transitive-deps[Gradle doc, "Sharing dependency versions between projects / Using a platform to control transitive versions"] に `platform(...)` 関する説明があります。

image:file.png[] `url-verifier-plugin/settings.gradle`
[source,groovy]
----
include::../../url-verifier-plugin/settings.gradle[lines=3..11]
----

ここでわたしは
link:https://docs.gradle.org/current/userguide/platforms.html["Version Catalog"] を使いました。Version Catalogを使って `"org.spockframework:spock-core:2.0-groovy-3.0"` という記述に対して短い別名 (`libs.spock.core`) を定義しました。別名を使うことにより、`2.0-groovy-3.0` というバージョン番号を書くのを１箇所だけにすることができました。 _Don't Repeat yourself_ 原則を適用することができました。


=== ユニット・テストのコード

`org.myorg.http.HttpResponse` クラスに対するユニット・テストのコードは下記の通りです。

image:file.png[] `url-verifier-plugin/src/test/groovy/org/myorg/http/HttpResponseTest.groovy`
[source,groovy]
----
include::../../url-verifier-plugin/src/test/groovy/org/myorg/http/HttpResponseTest.groovy[]
----

`HttpResponseTest` クラスにメソッドを増やしてもっと網羅的なテストにすることができます。また`main`にある他のクラスに対するユニット・テストを追加することももちろんできます。

=== インテグレーション・テストのコード

The following test code makes an HTTP request to an external URL ("https://www.google.com/"). This requires connectivity to the Internet, and it assumes that the external URL is available when you execute this test. When the external resources are not accessible, this test will fail.

We categorise those tests that depend on external resources as "Integration Test" and separate them from the unit-tests.

image:file.png[] `url-verifier-plugin/src/integrationTest/groovy/org/myorg/http/DefaultHttpCallerIntegrationTest.groovy`
[source,groovy]
----
include::../../url-verifier-plugin/src/integrationTest/groovy/org/myorg/http/DefaultHttpCallerIntegrationTest.groovy[]
----



=== Code for Functional test

The following test code runs the custom Gradle plugin and verifies the outcomes of the plugin.

- The test code generates a "build.gradle" in a temporary file which loads the custom plugin of id `org.myorg.url-verifier`.
- The plugin automatically adds a custom task `:verifyUrl` into the project constructed with the temporary build file.
- The test code runs Gradle just in the same way as you type in the console:
```
$ gradle verifyUrl https://www.google.com/
```
- The test code fetches the output from the custom plugin and verifies it.

image:file.png[] `url-verifier-plugin/src/functionalTest/groovy/org/myorg/UrlVerifierPluginFunctionalTest.groovy`
[source,groovy]
----
include::../../url-verifier-plugin/src/functionalTest/groovy/org/myorg/UrlVerifierPluginFunctionalTest.groovy[]
----


